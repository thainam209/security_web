import React, { useState } from 'react';
import axios from 'axios';
import { useToast } from '../contexts/ToastContext';

const inferLocalApiUrl = () => {
  if (typeof window === 'undefined') return null;
  const origin = window.location.origin;
  if (origin.includes('localhost:5173')) {
    return origin.replace('5173', '8080');
  }
  return origin;
};

const API_URL =
  import.meta.env.VITE_API_URL ||
  inferLocalApiUrl() ||
  'http://localhost:8080';

const PentestDemo = () => {
  const toast = useToast();
  const [activeTab, setActiveTab] = useState('xss-reflected');
  
  // XSS States
  const [xssReflectedInput, setXssReflectedInput] = useState('<script>alert("XSS Reflected")</script>');
  const [xssReflectedResult, setXssReflectedResult] = useState(null);
  const [xssStoredComment, setXssStoredComment] = useState('<script>alert("XSS Stored")</script>');
  const [xssStoredAuthor, setXssStoredAuthor] = useState('Hacker');
  const [xssList, setXssList] = useState([]);
  
  // SQLi States
  const [sqliSearchQuery, setSqliSearchQuery] = useState(`admin' OR '1'='1`);
  const [sqliSearchResult, setSqliSearchResult] = useState(null);
  const [sqliLoginUsername, setSqliLoginUsername] = useState(`admin' OR '1'='1--`);
  const [sqliLoginPassword, setSqliLoginPassword] = useState('anything');
  const [sqliLoginResult, setSqliLoginResult] = useState(null);
  const [sqliUserId, setSqliUserId] = useState(`1' UNION SELECT username, password FROM users--`);
  const [sqliUserResult, setSqliUserResult] = useState(null);

  // XSS Reflected Test
  const testXSSReflected = async () => {
    try {
      const response = await axios.get(`${API_URL}/api/v1/pentest/xss/reflected`, {
        params: { search: xssReflectedInput }
      });
      setXssReflectedResult(response.data);
      toast.success('Request th√†nh c√¥ng! Ki·ªÉm tra console v√† response.');
    } catch (error) {
      toast.error('L·ªói: ' + (error.response?.data?.error || error.message));
    }
  };

  // XSS Stored Test
  const testXSSStored = async () => {
    try {
      const response = await axios.post(`${API_URL}/api/v1/pentest/xss/stored`, {
        comment: xssStoredComment,
        author: xssStoredAuthor
      });
      toast.success('Comment ƒë√£ ƒë∆∞·ª£c l∆∞u!');
      // Refresh list
      fetchXSSList();
    } catch (error) {
      toast.error('L·ªói: ' + (error.response?.data?.error || error.message));
    }
  };

  // XSS List
  const fetchXSSList = async () => {
    try {
      const response = await axios.get(`${API_URL}/api/v1/pentest/xss/list`);
      setXssList(response.data.data || []);
    } catch (error) {
      toast.error('L·ªói: ' + (error.response?.data?.error || error.message));
    }
  };

  // SQLi Search Test
  const testSQLiSearch = async () => {
    try {
      const response = await axios.get(`${API_URL}/api/v1/pentest/sqli/search`, {
        params: { query: sqliSearchQuery }
      });
      setSqliSearchResult(response.data);
      toast.success('Request th√†nh c√¥ng! Ki·ªÉm tra k·∫øt qu·∫£.');
    } catch (error) {
      toast.error('L·ªói: ' + (error.response?.data?.error || error.message));
      setSqliSearchResult(error.response?.data);
    }
  };

  // SQLi Login Test
  const testSQLiLogin = async () => {
    try {
      const response = await axios.post(`${API_URL}/api/v1/pentest/sqli/login`, {
        username: sqliLoginUsername,
        password: sqliLoginPassword
      });
      setSqliLoginResult(response.data);
      toast.success('Login attempt completed!');
    } catch (error) {
      toast.error('L·ªói: ' + (error.response?.data?.error || error.message));
      setSqliLoginResult(error.response?.data);
    }
  };

  // SQLi User Test
  const testSQLiUser = async () => {
    try {
      const response = await axios.get(`${API_URL}/api/v1/pentest/sqli/user`, {
        params: { id: sqliUserId }
      });
      setSqliUserResult(response.data);
      toast.success('Request th√†nh c√¥ng!');
    } catch (error) {
      toast.error('L·ªói: ' + (error.response?.data?.error || error.message));
      setSqliUserResult(error.response?.data);
    }
  };

  // Load XSS list on mount
  React.useEffect(() => {
    if (activeTab === 'xss-stored') {
      fetchXSSList();
    }
  }, [activeTab]);

  return (
    <div className="container mx-auto px-4 py-8 max-w-6xl">
      <div className="bg-red-50 border-2 border-red-500 rounded-lg p-4 mb-6">
        <h1 className="text-2xl font-bold text-red-700 mb-2">‚ö†Ô∏è PENTEST DEMO - CH·ªà D√ôNG ƒê·ªÇ H·ªåC T·∫¨P</h1>
        <p className="text-red-600">
          Trang n√†y ch·ª©a c√°c l·ªó h·ªïng b·∫£o m·∫≠t c·ªë √Ω ƒë·ªÉ demo pentest. 
          <strong> KH√îNG S·ª¨ D·ª§NG TRONG PRODUCTION!</strong>
        </p>
      </div>

      {/* Tabs */}
      <div className="flex space-x-2 mb-6 border-b">
        <button
          onClick={() => setActiveTab('xss-reflected')}
          className={`px-4 py-2 ${activeTab === 'xss-reflected' ? 'border-b-2 border-blue-500 font-bold' : ''}`}
        >
          XSS Reflected
        </button>
        <button
          onClick={() => setActiveTab('xss-stored')}
          className={`px-4 py-2 ${activeTab === 'xss-stored' ? 'border-b-2 border-blue-500 font-bold' : ''}`}
        >
          XSS Stored
        </button>
        <button
          onClick={() => setActiveTab('sqli-search')}
          className={`px-4 py-2 ${activeTab === 'sqli-search' ? 'border-b-2 border-blue-500 font-bold' : ''}`}
        >
          SQLi Search
        </button>
        <button
          onClick={() => setActiveTab('sqli-login')}
          className={`px-4 py-2 ${activeTab === 'sqli-login' ? 'border-b-2 border-blue-500 font-bold' : ''}`}
        >
          SQLi Login
        </button>
        <button
          onClick={() => setActiveTab('sqli-union')}
          className={`px-4 py-2 ${activeTab === 'sqli-union' ? 'border-b-2 border-blue-500 font-bold' : ''}`}
        >
          SQLi UNION
        </button>
      </div>

      {/* XSS Reflected */}
      {activeTab === 'xss-reflected' && (
        <div className="bg-white p-6 rounded-lg shadow">
          <h2 className="text-xl font-bold mb-4">XSS Reflected Demo</h2>
          <p className="mb-4 text-gray-600">
            Nh·∫≠p payload XSS v√†o √¥ search. Payload s·∫Ω ƒë∆∞·ª£c tr·∫£ v·ªÅ trong response m√† kh√¥ng ƒë∆∞·ª£c sanitize.
          </p>
          <div className="space-y-4">
            <div>
              <label className="block mb-2 font-semibold">Search Input:</label>
              <input
                type="text"
                value={xssReflectedInput}
                onChange={(e) => setXssReflectedInput(e.target.value)}
                className="w-full p-2 border rounded"
                placeholder="<script>alert('XSS')</script>"
              />
            </div>
            <button
              onClick={testXSSReflected}
              className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
            >
              Test XSS Reflected
            </button>
            {xssReflectedResult && (
              <div className="mt-4 p-4 bg-gray-100 rounded">
                <h3 className="font-bold mb-2">Response:</h3>
                <pre className="text-sm overflow-auto">
                  {JSON.stringify(xssReflectedResult, null, 2)}
                </pre>
                <div className="mt-4 p-4 bg-yellow-50 border border-yellow-300 rounded">
                  <p className="font-semibold">‚ö†Ô∏è L∆∞u √Ω:</p>
                  <p>N·∫øu response ƒë∆∞·ª£c render tr·ª±c ti·∫øp trong HTML, script s·∫Ω ƒë∆∞·ª£c th·ª±c thi.</p>
                  <p className="mt-2">Th·ª≠ payload: <code className="bg-gray-200 px-2 py-1 rounded">&lt;img src=x onerror=alert('XSS')&gt;</code></p>
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {/* XSS Stored */}
      {activeTab === 'xss-stored' && (
        <div className="bg-white p-6 rounded-lg shadow">
          <h2 className="text-xl font-bold mb-4">XSS Stored Demo</h2>
          <p className="mb-4 text-gray-600">
            L∆∞u comment c√≥ ch·ª©a XSS payload. Comment s·∫Ω ƒë∆∞·ª£c l∆∞u v√† hi·ªÉn th·ªã l·∫°i m√† kh√¥ng ƒë∆∞·ª£c sanitize.
          </p>
          <div className="space-y-4">
            <div>
              <label className="block mb-2 font-semibold">Author:</label>
              <input
                type="text"
                value={xssStoredAuthor}
                onChange={(e) => setXssStoredAuthor(e.target.value)}
                className="w-full p-2 border rounded"
              />
            </div>
            <div>
              <label className="block mb-2 font-semibold">Comment (XSS Payload):</label>
              <textarea
                value={xssStoredComment}
                onChange={(e) => setXssStoredComment(e.target.value)}
                className="w-full p-2 border rounded"
                rows="3"
              />
            </div>
            <button
              onClick={testXSSStored}
              className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
            >
              L∆∞u Comment
            </button>
            <button
              onClick={fetchXSSList}
              className="ml-2 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
            >
              Refresh List
            </button>
            <div className="mt-4">
              <h3 className="font-bold mb-2">Danh s√°ch Comments:</h3>
              <div className="space-y-2">
                {xssList.map((item) => (
                  <div key={item.id} className="p-3 bg-gray-100 rounded">
                    <p className="font-semibold">{item.author}:</p>
                    {/* ‚ö†Ô∏è VULNERABILITY: dangerouslySetInnerHTML - kh√¥ng n√™n d√πng trong production */}
                    <div dangerouslySetInnerHTML={{ __html: item.comment }} />
                    <p className="text-xs text-gray-500 mt-1">{item.createdAt}</p>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* SQLi Search */}
      {activeTab === 'sqli-search' && (
        <div className="bg-white p-6 rounded-lg shadow">
          <h2 className="text-xl font-bold mb-4">SQL Injection - Search Demo</h2>
          <p className="mb-4 text-gray-600">
            Th·ª≠ c√°c payload SQL injection ƒë·ªÉ khai th√°c l·ªó h·ªïng trong t√¨m ki·∫øm.
          </p>
          <div className="space-y-4">
            <div>
              <label className="block mb-2 font-semibold">Search Query:</label>
              <input
                type="text"
                value={sqliSearchQuery}
                onChange={(e) => setSqliSearchQuery(e.target.value)}
                className="w-full p-2 border rounded font-mono"
                placeholder="admin' OR '1'='1"
              />
            </div>
            <div className="bg-yellow-50 p-3 rounded border border-yellow-300">
              <p className="font-semibold mb-2">Payloads th·ª≠:</p>
              <ul className="list-disc list-inside space-y-1 text-sm">
                <li><code>admin' OR '1'='1</code> - L·∫•y t·∫•t c·∫£ users</li>
                <li><code>' UNION SELECT null, null, null--</code> - Test UNION</li>
                <li><code>' OR 1=1--</code> - Bypass filter</li>
              </ul>
            </div>
            <button
              onClick={testSQLiSearch}
              className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
            >
              Test SQL Injection
            </button>
            {sqliSearchResult && (
              <div className="mt-4 p-4 bg-gray-100 rounded">
                <h3 className="font-bold mb-2">Response:</h3>
                <pre className="text-sm overflow-auto">
                  {JSON.stringify(sqliSearchResult, null, 2)}
                </pre>
              </div>
            )}
          </div>
        </div>
      )}

      {/* SQLi Login */}
      {activeTab === 'sqli-login' && (
        <div className="bg-white p-6 rounded-lg shadow">
          <h2 className="text-xl font-bold mb-4">SQL Injection - Login Bypass Demo</h2>
          <p className="mb-4 text-gray-600">
            Th·ª≠ bypass authentication b·∫±ng SQL injection.
          </p>
          <div className="space-y-4">
            <div>
              <label className="block mb-2 font-semibold">Username:</label>
              <input
                type="text"
                value={sqliLoginUsername}
                onChange={(e) => setSqliLoginUsername(e.target.value)}
                className="w-full p-2 border rounded font-mono"
                placeholder="admin' OR '1'='1--"
              />
            </div>
            <div>
              <label className="block mb-2 font-semibold">Password:</label>
              <input
                type="text"
                value={sqliLoginPassword}
                onChange={(e) => setSqliLoginPassword(e.target.value)}
                className="w-full p-2 border rounded"
              />
            </div>
            <div className="bg-yellow-50 p-3 rounded border border-yellow-300">
              <p className="font-semibold mb-2">Payload:</p>
              <code className="text-sm">admin' OR '1'='1--</code>
              <p className="text-xs mt-2">Payload n√†y s·∫Ω comment ph·∫ßn password check.</p>
            </div>
            <button
              onClick={testSQLiLogin}
              className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
            >
              Test Login Bypass
            </button>
            {sqliLoginResult && (
              <div className="mt-4 p-4 bg-gray-100 rounded">
                <h3 className="font-bold mb-2">Response:</h3>
                <pre className="text-sm overflow-auto">
                  {JSON.stringify(sqliLoginResult, null, 2)}
                </pre>
              </div>
            )}
          </div>
        </div>
      )}

      {/* SQLi UNION */}
      {activeTab === 'sqli-union' && (
        <div className="bg-white p-6 rounded-lg shadow">
          <h2 className="text-xl font-bold mb-4">SQL Injection - UNION SELECT Demo</h2>
          <p className="mb-4 text-gray-600">
            S·ª≠ d·ª•ng UNION SELECT ƒë·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ c√°c b·∫£ng kh√°c.
          </p>
          <div className="space-y-4">
            <div>
              <label className="block mb-2 font-semibold">User ID (SQLi Payload):</label>
              <input
                type="text"
                value={sqliUserId}
                onChange={(e) => setSqliUserId(e.target.value)}
                className="w-full p-2 border rounded font-mono"
                placeholder="1' UNION SELECT username, password FROM users--"
              />
            </div>
            <div className="bg-yellow-50 p-3 rounded border border-yellow-300">
              <p className="font-semibold mb-2">Payloads th·ª≠:</p>
              <ul className="list-disc list-inside space-y-1 text-sm">
                <li><code>1' UNION SELECT username, password FROM users--</code></li>
                <li><code>1' UNION SELECT null, null, null--</code> - T√¨m s·ªë c·ªôt</li>
                <li><code>1' ORDER BY 1--</code> - T√¨m s·ªë c·ªôt b·∫±ng ORDER BY</li>
              </ul>
            </div>
            <button
              onClick={testSQLiUser}
              className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
            >
              Test UNION SELECT
            </button>
            {sqliUserResult && (
              <div className="mt-4 p-4 bg-gray-100 rounded">
                <h3 className="font-bold mb-2">Response:</h3>
                <pre className="text-sm overflow-auto">
                  {JSON.stringify(sqliUserResult, null, 2)}
                </pre>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Info Section */}
      <div className="mt-8 bg-blue-50 p-6 rounded-lg border border-blue-300">
        <h2 className="text-xl font-bold mb-4">üìö H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng Burp Suite/ZAP</h2>
        <div className="space-y-3 text-sm">
          <p><strong>1. C√†i ƒë·∫∑t Burp Suite Community ho·∫∑c OWASP ZAP</strong></p>
          <p><strong>2. C·∫•u h√¨nh proxy:</strong></p>
          <ul className="list-disc list-inside ml-4">
            <li>Burp: Proxy ‚Üí Options ‚Üí Proxy Listeners (127.0.0.1:8080)</li>
            <li>ZAP: Tools ‚Üí Options ‚Üí Local Proxy (127.0.0.1:8080)</li>
          </ul>
          <p><strong>3. C·∫•u h√¨nh browser:</strong> Set proxy HTTP/HTTPS ‚Üí 127.0.0.1:8080</p>
          <p><strong>4. Intercept requests:</strong> B·∫Øt c√°c request t·ª´ trang n√†y v√† modify payload</p>
          <p><strong>5. Xem file h∆∞·ªõng d·∫´n chi ti·∫øt:</strong> <code>PENTEST_GUIDE.md</code></p>
        </div>
      </div>
    </div>
  );
};

export default PentestDemo;

