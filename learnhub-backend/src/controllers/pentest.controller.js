const pentestService = require('../services/pentest.service');

// ⚠️ PENTEST DEMO CONTROLLERS - CHỨA LỖ HỔNG CỐ Ý ⚠️

/**
 * XSS Reflected - Không sanitize input từ query parameter
 * Demo: GET /api/v1/pentest/xss/reflected?search=<script>alert('XSS')</script>
 */
exports.xssReflected = async (req, res) => {
    try {
        const search = req.query.search || '';
        
        // ⚠️ VULNERABILITY: Trả về input trực tiếp không sanitize
        res.json({
            message: 'Kết quả tìm kiếm',
            search: search, // ⚠️ Lỗ hổng XSS - không escape HTML
            results: []
        });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
};

/**
 * XSS Stored - Lưu comment không sanitize vào "database" (memory)
 * Demo: POST /api/v1/pentest/xss/stored {comment: "<script>alert('XSS')</script>"}
 */
exports.xssStored = async (req, res) => {
    try {
        const { comment, author } = req.body;
        
        if (!comment) {
            return res.status(400).json({ error: 'Comment is required' });
        }
        
        // ⚠️ VULNERABILITY: Lưu comment không sanitize
        const saved = await pentestService.saveComment(comment, author || 'Anonymous');
        
        res.json({
            message: 'Comment đã được lưu',
            data: saved
        });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
};

/**
 * XSS List - Hiển thị danh sách comments (không escape)
 * Demo: GET /api/v1/pentest/xss/list
 */
exports.xssList = async (req, res) => {
    try {
        const comments = await pentestService.getComments();
        
        // ⚠️ VULNERABILITY: Trả về comments không sanitize
        res.json({
            message: 'Danh sách comments',
            data: comments
        });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
};

/**
 * SQL Injection - Search với raw query
 * Demo: GET /api/v1/pentest/sqli/search?query=admin' OR '1'='1
 */
exports.sqliSearch = async (req, res) => {
    try {
        const query = req.query.query || '';
        
        // ⚠️ VULNERABILITY: SQL Injection - sử dụng raw query không parameterized
        const results = await pentestService.sqliSearch(query);
        
        res.json({
            message: 'Kết quả tìm kiếm',
            query: query,
            results: results
        });
    } catch (error) {
        res.status(500).json({ 
            error: error.message,
            // ⚠️ Hiển thị lỗi SQL có thể leak thông tin
            details: process.env.NODE_ENV === 'development' ? error.stack : undefined
        });
    }
};

/**
 * SQL Injection - Login bypass
 * Demo: POST /api/v1/pentest/sqli/login 
 * Body: {username: "admin' OR '1'='1--", password: "anything"}
 */
exports.sqliLogin = async (req, res) => {
    try {
        const { username, password } = req.body;
        
        if (!username || !password) {
            return res.status(400).json({ error: 'Username and password are required' });
        }
        
        // ⚠️ VULNERABILITY: SQL Injection trong login
        const user = await pentestService.sqliLogin(username, password);
        
        if (user) {
            res.json({
                message: 'Đăng nhập thành công',
                user: {
                    id: user.id,
                    username: user.username,
                    role: user.role
                }
            });
        } else {
            res.status(401).json({ error: 'Đăng nhập thất bại' });
        }
    } catch (error) {
        res.status(500).json({ 
            error: error.message,
            details: process.env.NODE_ENV === 'development' ? error.stack : undefined
        });
    }
};

/**
 * SQL Injection - User info với UNION SELECT
 * Demo: GET /api/v1/pentest/sqli/user?id=1' UNION SELECT username, password FROM users--
 */
exports.sqliUser = async (req, res) => {
    try {
        const id = req.query.id || '1';
        
        // ⚠️ VULNERABILITY: SQL Injection với UNION SELECT
        const user = await pentestService.sqliGetUser(id);
        
        res.json({
            message: 'Thông tin user',
            data: user
        });
    } catch (error) {
        res.status(500).json({ 
            error: error.message,
            details: process.env.NODE_ENV === 'development' ? error.stack : undefined
        });
    }
};

