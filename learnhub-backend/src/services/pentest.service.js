const { sequelize } = require('../models');
const { QueryTypes } = require('sequelize');

// ⚠️ PENTEST DEMO SERVICE - CHỨA LỖ HỔNG SQL INJECTION CỐ Ý ⚠️

// In-memory storage cho XSS stored demo (thay vì database thật)
let commentsStorage = [];

/**
 * Lưu comment (không sanitize) - XSS Stored Demo
 */
exports.saveComment = async (comment, author) => {
    const newComment = {
        id: commentsStorage.length + 1,
        comment: comment, // ⚠️ Không sanitize
        author: author || 'Anonymous',
        createdAt: new Date().toISOString()
    };
    
    commentsStorage.push(newComment);
    return newComment;
};

/**
 * Lấy danh sách comments - XSS Stored Demo
 */
exports.getComments = async () => {
    return commentsStorage;
};

/**
 * SQL Injection - Search vulnerability
 * ⚠️ VULNERABILITY: Sử dụng string concatenation thay vì parameterized query
 */
exports.sqliSearch = async (query) => {
    try {
        // ⚠️ NGUY HIỂM: Raw SQL với string concatenation
        const sql = `SELECT id, username, email, role 
                     FROM users 
                     WHERE username LIKE '%${query}%' 
                     OR email LIKE '%${query}%'`;
        
        const results = await sequelize.query(sql, {
            type: QueryTypes.SELECT
        });
        
        return results;
    } catch (error) {
        throw new Error(`SQL Error: ${error.message}`);
    }
};

/**
 * SQL Injection - Login bypass vulnerability
 * ⚠️ VULNERABILITY: SQL Injection trong authentication
 */
exports.sqliLogin = async (username, password) => {
    try {
        // ⚠️ NGUY HIỂM: Raw SQL với string concatenation
        // Payload: admin' OR '1'='1--
        const sql = `SELECT id, username, email, role, password 
                     FROM users 
                     WHERE username = '${username}' 
                     AND password = '${password}'`;
        
        const results = await sequelize.query(sql, {
            type: QueryTypes.SELECT
        });
        
        // Trong thực tế, password phải được hash, nhưng đây là demo
        if (results.length > 0) {
            return {
                id: results[0].id,
                username: results[0].username,
                email: results[0].email,
                role: results[0].role
            };
        }
        
        return null;
    } catch (error) {
        throw new Error(`SQL Error: ${error.message}`);
    }
};

/**
 * SQL Injection - User info với UNION SELECT vulnerability
 * ⚠️ VULNERABILITY: UNION SELECT injection
 */
exports.sqliGetUser = async (id) => {
    try {
        // ⚠️ NGUY HIỂM: Raw SQL với string concatenation
        // Payload: 1' UNION SELECT username, password FROM users--
        const sql = `SELECT id, username, email 
                     FROM users 
                     WHERE id = ${id}`;
        
        const results = await sequelize.query(sql, {
            type: QueryTypes.SELECT
        });
        
        return results;
    } catch (error) {
        throw new Error(`SQL Error: ${error.message}`);
    }
};

